# .github/workflows/docker-publish.yml

name: Build and Push Docker Images to ACR

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repository code
      - name: Check out code
        uses: actions/checkout@v3

      # 2. Set up JDK 17 for building the backend
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Set up Node.js for building the frontend
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 4. Log in to Aliyun Container Registry (ACR)
      - name: Log in to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_REGISTRY_URL }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 5. Build and Push Backend Image
      - name: Build and Push Backend
        run: |
          # The repository name is the same as the namespace
          IMAGE_NAME="${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/${{ secrets.ACR_NAMESPACE }}:backend-${{ github.sha }}"
          
          echo "Building and pushing backend image: $IMAGE_NAME"
          
          docker build \
            --build-arg DB_URL="${{ secrets.DB_URL }}" \
            --build-arg DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            --build-arg DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --build-arg JWT_JWK_SET_URI="${{ secrets.JWT_JWK_SET_URI }}" \
            --build-arg ALIYUN_LLM_API_KEY="${{ secrets.ALIYUN_LLM_API_KEY }}" \
            -t "$IMAGE_NAME" \
            -f backend/Dockerfile.backend \
            ./backend
            
          docker push "$IMAGE_NAME"

      # 6. Build and Push Frontend Image
      - name: Build and Push Frontend
        run: |
          # The repository name is the same as the namespace
          IMAGE_NAME="${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/${{ secrets.ACR_NAMESPACE }}:frontend-${{ github.sha }}"
          
          echo "Building and pushing frontend image: $IMAGE_NAME"
          
          # Create the .env file for the build process
          echo "VITE_AMAP_KEY=${{ secrets.AMAP_KEY }}" > ./frontend/.env
          
          docker build \
            -t "$IMAGE_NAME" \
            -f frontend/Dockerfile.frontend \
            ./frontend
            
          docker push "$IMAGE_NAME"

      # 7. (Optional) Clean up .env file
      - name: Clean up frontend .env file
        if: always()
        run: rm ./frontend/.env
