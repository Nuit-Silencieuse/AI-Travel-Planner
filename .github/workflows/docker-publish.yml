# .github/workflows/docker-publish.yml

name: Build and Push Docker Images to ACR

# This workflow runs when code is pushed to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest # Use a Linux runner

    steps:
      # 1. Check out the repository code
      - name: Check out code
        uses: actions/checkout@v3

      # 2. Set up JDK 17 for building the backend
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Set up Node.js for building the frontend
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 4. Log in to Aliyun Container Registry (ACR)
      - name: Log in to ACR
        uses: docker/login-action@v2
        with:
          registry: registry.${{ secrets.ACR_REGION }}.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 5. Build and Push Backend Image
      - name: Build and Push Backend
        run: |
          docker build \
            -t registry.${{ secrets.ACR_REGION }}.aliyuncs.com/${{ secrets.ACR_INSTANCE_NAME }}/ai-travel-planner-backend:${{ github.sha }} \
            -f backend/Dockerfile.backend \
            ./backend
          docker push registry.${{ secrets.ACR_REGION }}.aliyuncs.com/${{ secrets.ACR_INSTANCE_NAME }}/ai-travel-planner-backend:${{ github.sha }}

      # 6. Build and Push Frontend Image
      - name: Build and Push Frontend
        run: |
          # Create the .env file for the build process
          echo "VITE_AMAP_KEY=${{ secrets.AMAP_KEY }}" > ./frontend/.env
          
          docker build \
            -t registry.${{ secrets.ACR_REGION }}.aliyuncs.com/${{ secrets.ACR_INSTANCE_NAME }}/ai-travel-planner-frontend:${{ github.sha }} \
            -f frontend/Dockerfile.frontend \
            ./frontend
          docker push registry.${{ secrets.ACR_REGION }}.aliyuncs.com/${{ secrets.ACR_INSTANCE_NAME }}/ai-travel-planner-frontend:${{ github.sha }}

      # 7. (Optional) Clean up .env file
      - name: Clean up frontend .env file
        if: always() # Always run this step, even if previous steps fail
        run: rm ./frontend/.env
